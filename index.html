<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Store DZ - Ù…ØªØ¬Ø± Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00d2ff; --bg: #0b0e14; --card: #151921; --text: #ffffff; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; text-align: center; }
        .page { display: none; padding: 20px; }
        .active { display: block; }
        
        /* ØªØµÙ…ÙŠÙ… ÙƒØ±ÙˆØª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
        .container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; max-width: 1100px; margin: 20px auto; padding: 10px; }
        .card { background: var(--card); border-radius: 15px; padding: 20px; border: 1px solid #2d343f; transition: 0.3s; }
        .card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .price { color: var(--primary); font-size: 1.4rem; font-weight: bold; margin: 15px 0; display: block; }
        select { width: 100%; padding: 10px; border-radius: 8px; background: #0b0e14; color: white; border: 1px solid var(--primary); margin-bottom: 10px; }
        
        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn { background: var(--primary); color: #000; border: none; padding: 12px 25px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; }
        .btn-google { background: white; color: #444; width: auto; display: inline-flex; align-items: center; gap: 10px; margin-top: 20px; }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        #orderModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; padding:20px; box-sizing:border-box; }
        .modal-content { background: var(--card); width:100%; max-width:400px; margin:50px auto; padding:25px; border-radius:20px; border:1px solid var(--primary); text-align:right; }
        textarea { width:100%; padding:10px; border-radius:8px; background:var(--bg); color:white; border:1px solid #2d343f; resize:none; box-sizing:border-box; }
    </style>
</head>
<body>

    <div id="loginPage" class="page active">
        <h1 style="margin-top: 100px;">Market Store DZ</h1>
        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„ØªØ³ÙˆÙ‚</p>
        <button class="btn btn-google" onclick="loginWithGoogle()">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20">
            Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ø¬ÙˆØ¬Ù„
        </button>
    </div>

    <div id="mainPage" class="page">
        <header style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #2d343f;">
            <span>Ù…Ø±Ø­Ø¨Ø§Ù‹: <strong id="userName"></strong> ğŸ‘‹</span>
            <button onclick="logout()" style="color:#ff4757; background:none; border:none; cursor:pointer;">Ø®Ø±ÙˆØ¬</button>
        </header>

        <div class="container">
            <div class="card">
                <h3>Gemini AI Plus</h3>
                <p>Ø§Ø´ØªØ±Ø§Ùƒ Ø´Ù‡Ø± ÙˆØ§Ø­Ø¯ - Ø­Ø³Ø§Ø¨ Ø®Ø§Øµ</p>
                <span class="price">800 Ø¯Ø¬</span>
                <button class="btn" onclick="openOrderModal('Gemini AI Plus', '800 Ø¯Ø¬')">Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>
            </div>

            <div class="card">
                <h3>eFootball Coins</h3>
                <select id="efootballOpt">
                    <option value="1040 Coins - 1500 Ø¯Ø¬">1040 Coins - 1500 Ø¯Ø¬</option>
                    <option value="2130 Coins - 3000 Ø¯Ø¬">2130 Coins - 3000 Ø¯Ø¬</option>
                </select>
                <button class="btn" onclick="processSelectOrder('efootballOpt', 'eFootball')">Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>
            </div>

            <div class="card">
                <h3>Free Fire</h3>
                <select id="ffOpt">
                    <option value="100 Ø¬ÙˆÙ‡Ø±Ø© - 300 Ø¯Ø¬">100 Ø¬ÙˆÙ‡Ø±Ø© - 300 Ø¯Ø¬</option>
                    <option value="Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© - 2850 Ø¯Ø¬">Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© - 2850 Ø¯Ø¬</option>
                </select>
                <button class="btn" onclick="processSelectOrder('ffOpt', 'Free Fire')">Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>
            </div>
        </div>
    </div>

    <div id="orderModal">
        <div class="modal-content">
            <h3 id="modalTitle" style="color:var(--primary);">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</h3>
            <p id="modalPrice" style="font-weight:bold;"></p>
            
            <label style="font-size:13px; color:#888;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø¬ÙŠÙ…ÙŠÙ„ + Ø¨Ø§Ø³ÙˆØ±Ø¯ / ID):</label>
            <textarea id="accountDetails" rows="3" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§..."></textarea>

            <div style="margin-top:15px;">
                <label style="font-size:13px; color:#888;">Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© ÙˆØµÙ„ Ø§Ù„Ø¯ÙØ¹ (Ø¨Ø±ÙŠØ¯ÙŠ Ù…ÙˆØ¨/CCP):</label>
                <input type="file" id="receiptFile" accept="image/*" style="width:100%; margin-top:5px;">
            </div>
            
            <button class="btn" id="confirmBtn" onclick="submitFinalOrder()" style="margin-top:20px;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„ÙˆØµÙ„ âœ…</button>
            <button onclick="closeModal()" style="background:none; color:#ff4757; border:none; width:100%; margin-top:10px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAU3uhD1AbrtYCvcaAIKYFERQfjfyoZjSo",
            authDomain: "market-dz-3cd05.firebaseapp.com",
            projectId: "market-dz-3cd05",
            storageBucket: "market-dz-3cd05.firebasestorage.app",
            messagingSenderId: "74224676367",
            appId: "1:74224676367:web:987c2a6496ea03a63b7d7a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();

        let currentItem = "", currentPrice = "";

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('userName').innerText = user.displayName;
                document.getElementById('loginPage').classList.remove('active');
                document.getElementById('mainPage').classList.add('active');
                
                // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø²Ø¨ÙˆÙ†
                onSnapshot(collection(db, "orders"), (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "modified") {
                            const data = change.doc.data();
                            if (data.customerEmail === user.email && data.status === "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…") {
                                alert("ğŸ‰ Ø¨Ø´Ø±Ù‰ Ø³Ø§Ø±Ø©! ØªÙ… ØªØ³Ù„ÙŠÙ… Ø·Ù„Ø¨Ùƒ: " + data.product);
                            }
                        }
                    });
                });
            } else {
                document.getElementById('loginPage').classList.add('active');
                document.getElementById('mainPage').classList.remove('active');
            }
        });

        window.loginWithGoogle = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);

        window.processSelectOrder = (id, cat) => {
            const val = document.getElementById(id).value;
            const [item, price] = val.split(" - ");
            window.openOrderModal(cat + " (" + item + ")", price);
        };

        window.openOrderModal = (name, price) => {
            currentItem = name; currentPrice = price;
            document.getElementById('modalTitle').innerText = name;
            document.getElementById('modalPrice').innerText = price;
            document.getElementById('orderModal').style.display = 'block';
        };

        window.closeModal = () => document.getElementById('orderModal').style.display = 'none';

        window.submitFinalOrder = async () => {
            const details = document.getElementById('accountDetails').value;
            const file = document.getElementById('receiptFile').files[0];
            if (!details || !file) return alert("Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø±ÙØ¹ Ø§Ù„ÙˆØµÙ„!");

            try {
                document.getElementById('confirmBtn').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
                document.getElementById('confirmBtn').disabled = true;

                const storageRef = ref(storage, 'receipts/' + Date.now());
                const snapshot = await uploadBytes(storageRef, file);
                const url = await getDownloadURL(snapshot.ref);

                await addDoc(collection(db, "orders"), {
                    customerName: auth.currentUser.displayName,
                    customerEmail: auth.currentUser.email,
                    product: currentItem,
                    price: currentPrice,
                    accountData: details,
                    receiptImg: url,
                    status: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
                    time: serverTimestamp()
                });

                alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!");
                closeModal();
            } catch (e) { alert("Ø®Ø·Ø£! ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Storage Ùˆ Rules"); }
            finally { 
                document.getElementById('confirmBtn').disabled = false;
                document.getElementById('confirmBtn').innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„ÙˆØµÙ„ âœ…";
            }
        };
    </script>
</body>
</html>
